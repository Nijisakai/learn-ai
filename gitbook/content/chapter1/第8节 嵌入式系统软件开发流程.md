# 第8节 嵌入式系统软件开发流程

嵌入式系统定义：嵌入式系统（Embedded Systems）由硬件和软件组成．是能够独立进行运作的器件。其软件内容只包括软件运行环境及其操作系统。硬件内容包括信号处理器、存储器、通信模块等在内的多方面的内容。  
嵌入式系统软件开发流程框图：

![alt embeded-sys](http://q6c64umf6.bkt.clouddn.com/embeded-sys.jpg)

## 嵌入式硬件平台

按照微处理器指令集类型来划分，分为复杂指令集（CISC，即Complex Instruction Set Computing）和精简指令集（RISC即Reduced Instruction Set Computing）。  
复杂指令集的处理器架构以x86和AMD64架构为主，主要应用在个人电脑，网站服务器等场景，复杂指令集的处理器的每条指令按顺序串行执行，控制相对简单，但速度相对较慢。  
精简指令集的处理器架构有ARM，AVR，MIPS等，这些架构各有特点；而在本次课程中用到的树莓派4开发板的处理器就属于ARM架构。本节主要以ARM架构为例讲解嵌入式系统软件开发流程。
![alt ARM-picture](http://e.hiphotos.baidu.com/baike/pic/item/ac6eddc451da81cbad0a8d5a5866d016082431bc.jpg)

## 嵌入式软件

嵌入式软件：嵌入式软件就是在嵌入式硬件中运行的操作系统和在嵌入式操作系统中的应用程序、驱动程序和应用程序等。

### 嵌入式操作系统

到目前嵌入式领域中的嵌入式操作系统有：Linux，Unix，Windows Embeded，VXWorks，RTOS等。而占据主要地位的是开源阵营的以Linux为核心的操作系统，如Android，Openwrt，Ubuntu，Debian，RedHat，CentOS等等。  
本次课程中用到的树莓派所用的操作系统就是以Debian为主深度优化的嵌入式操作系统：Raspbian，其系统核心仍然是Linux。  

### 操作系统是如何被制作出来的

#### 嵌入式ARM-Linux操作系统的结构

ARM-Linux操作系统由一下几部分构成：
|名称|说明|
:-:|:-:
|Bootloader|引导加载器：这是一段裸机程序，能够在硬件上电后完成对硬件的检测，初始化各个硬件模块，主要功能是完成加载并引导操作系统启动的工作；常见的Botloader有U-boot，Bread，Grub，BIOS等|
|Kernel|linux操作系统的内核：包含操作系统的各项功能，硬件的驱动等|
|Rootfs|根问文件系统：根文件系统提供对文件的管理、对文件系统的支持，以及提供Linux系统下的标准目录结构(详见本章第二节：Linux基本操作)|

下图为嵌入式linux操作系统在存储设备上的分区结构图：
![alt arm-linux](http://q6c64umf6.bkt.clouddn.com/arm-linux.jpg)  

注：Boot Env分区为U-boot环境变量存储分区，引导操作系统启动所需的相关配置信息就存储在此分区内。

#### 从源代码开始

由于Linux是开源操作系统，其源代码可以按照开源协议任意修改，也可以用于我们的嵌入式操作系统。  
操作系统的源码大多以C语言这种高级语言编写，所以从操作系统源代码开始，对源代码进行一定的“配置”，再通过编译器的“预处理”，“编译”，“汇编”，“链接”四步的深度加工，最后再经过固件打包工具的处理才能制作出能用的嵌入式操作系统。  
  
由于嵌入式处理器大多为精简指令集(RISC)处理器，其处理能力相对PC端处理器较弱，不适合用来编译操作系统固件，所以我们要在X86平台上编译ARM架构处理器能执行的操作系统软件，这种编译方式称为“交叉编译”。

#### 交叉编译的工具—交叉编译工具链

要把源代码制作成嵌入式操作系统的可烧写镜像(.img文件)，中间就需要交叉编译工具链(Toolchains)的操作，常用免费的的交叉编译工具链有：
|编译器|作用|
:-|:-
|arm-none-linux-gnueabi-gcc|1. Codesourcery 公司基于GCC推出的的ARM交叉编译工具。<br>2.用于交叉编译ARM(32位)系统中所有环节的代码，包括裸机程序、u-boot、Linux kernel、filesystem和App应用程序|
|arm-linux-gnueabihf-gcc|1.Linaro公司基于GCC推出的的ARM交叉编译工具。<br>2.用于交叉编译ARM(32位)系统中所有环节的代码，包括裸机程序、u-boot、Linux kernel、filesystem和App应用程序|
|aarch64-linux-gnu-gcc|1.Linaro公司基于GCC推出的的ARM交叉编译工具。<br>2.用于交叉编译ARMv8 64位目标中的裸机程序、u-boot、Linux kernel、filesystem和App应用程序|
|arm-none-elf-gcc|1.Codesourcery公司基于GCC推出的的ARM交叉编译工具。<br>2.用于交叉编译ARM MCU(32位)芯片，如ARM7、ARM9、Cortex-M/R芯片程序|
|arm-none-eabi-gcc|1.GNU推出的的ARM交叉编译工具。<br>2.用于交叉编译ARM MCU(32位)芯片，如ARM7、ARM9、Cortex-M/R芯片程序|

由于经交叉编译器处理U-boot、内核和根文件系统源码后只生成的其二进制文件，因此还需要将U-boot、内核(Kernel)和根文件系统(Rootfs)三者打包整合，最终生成可用的嵌入式操作系统固件(.img文件)。

### 嵌入式操作系统调试

#### TFTP和NFS远程挂载根文件系统

由于嵌入式开发板的存储设备容量较小，若交叉编译生成的系统镜像较大，每次将系统镜像烧写到板载存储设备中比较耗时，调试起来效率较低；因此，为避免这些问题，常使用TFTP和NFS远程挂载根文件系统的方式进行开发调试。步骤详见下表：
|名称|配置步骤|
:-:|:-
|Linux PC端|1.配置并开启TFTP和NFS服务；<br>2.设置有线网卡IP地址，使其与开发板网卡IP在同一网段；<br>3.将编译好的内核镜像(Kernel.img)放入TFTP服务指定的目录下；<br>4.将开发板可用的根文件系统放置于PC端的某个目录下|
|开发板|1.开发板启动到支持网络的U-boot下；<br>2.配置U-boot Env，使其IP地址与PC网卡IP在同一网段；<br>2.配置U-boot Env,从tftp服务器获取并启动内核和从NFS服务器获取并挂载根文件系统；<br>3.在U-boot的的命令行中键入启动命令，启动内核和挂载根文件系统。|

![alt linux-nfs](http://q6c64umf6.bkt.clouddn.com/linux-nfs.jpg)
上图为通过NFS方式远程挂载根文件系统(Rootfs)并启动内核。

### 嵌入式Linux操作系统基本操作

#### 通过SSH方式登录Linux系统

1. SSH：为安全外壳协议(Secure Shell);由 IETF 的网络小组（Network Working Group）所制定；SSH 为建立在应用层基础上的安全协议。SSH 是较可靠，专为远程登录会话和其他网络服务提供安全性的协议。利用 SSH 协议可以有效防止远程管理过程中的信息泄露问题。  
下图为使用Putty通过SSH方式访问树莓派：  
![alt rpi-ssh](http://q6c64umf6.bkt.clouddn.com/rpi-ssh.jpg)

2. xrdp:是Linux平台上的远程桌面的一种，通过在系统中开启此软件(服务)，就可以通过Windows操作系统中的“远程桌面”应用程序访问目标计算机的桌面，如下图所示：
![alt mstsc](http://q6c64umf6.bkt.clouddn.com/mstsc.jpg)

如上图所示，在局域网中，只需在 “计算机” 文本框中填入目标计算机的IP地址，即可访问到远程计算机的桌面。  
若远程桌面访问起来比较卡顿，可通过修改“显示选项”来改善：  

   1. 修改显示分辨率  
   ![alt mstsc-fbl](http://q6c64umf6.bkt.clouddn.com/mstsc-net.png)

   2. 修改网络传输类型  
   ![alt mstsc-net](http://q6c64umf6.bkt.clouddn.com/mstsc-set.png)

3.VNC：是第三方公司开发的远程桌面访问软件，树莓派官方系统直接对VNC服务端做了系统整合；只需在局域网的PC端安装“VNC Viewer”，即可通过此PC访问目标计算机在局域网中的IP地址来开启远程桌面。如下图所示：  

   ![alt vnc-viewer](http://q6c64umf6.bkt.clouddn.com/vnc-viewer.png)hyinn@live.com
