# 第3节 大白自动追踪

---

>通过拍照、爬虫等方式获取待训练图片，使用python进行简单的文件处理，用OpenCV训练后，可实现对特定物体的识别和追踪

### 级联分类器简介

目前图像检测方法主要分为两大类，**基于知识**和**基于统计**。

以人脸检测来说，基于知识的人脸检测方法主要包括：模板匹配，人脸特征，形状与边缘，纹理特征，颜色特征。

基于统计的人脸检测方法主要包括：主成分分析与特征脸法，神经网络模型，隐马尔可夫模型，支持向量机，Adaboost算法。

基于知识的方法将人脸看成不同特征的特定组合，即通过人脸的眼睛、嘴巴、鼻子、耳朵等特征及其组合关系来检测人脸。

基于统计的方法将人脸看成统一的二维像素矩阵，通过大量的样本构建人脸子空间，通过相似度的大小来判断人脸是否存在。

OpenCV采用的级联分类器，可以理解为将采用Adaboost算法构建的若干分类器串联起来，即级联。只有通过所有分类器后才识别为检测正确。这样可以提高检测的准确度。
![1446497-20180809111640447-741585916](https://md.hass.live/1446497-20180809111640447-741585916.png)

OpenCV提供了若干已经提前训练好的级联分类器供使用，包括人体、人脸、猫咪等。
![微信截图_20190808123116](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190808123116.png)

##### 示例：识别猫脸

核心代码：

``` python
String catFileName = "~/opencv/build/etc/haarcascades/haarcascade_frontalcatface.xml"
CascadeClassifier catclassifier
```

结果：
![微信截图_20190808132617](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190808132617.png)

### 活动1：人脸分类器：追着人跑的大白

#### 原理图

``` sequence
摄像头->大白\n树莓派: CSI/USB
大白\n树莓派-->Arduino: 串口指令
Note right of 大白\n树莓派: OpenCV处理摄像头数据（级联分类器）\n发送指令给Arduino
```

#### 硬件准备

- 大白车

- Arduino

- 树莓派摄像头

- 待识别的人或猫的照片（电子或纸质打印任选）

#### 硬件连接

- 将烧录好程序的Arduino通过USB连接到树莓派

#### 启动追踪小车

1.使用远程桌面或HDMI视频输出连接到树莓派

2.打开`终端`，输入`cd ~/Desktop/learn-ai/codes/chapter4/part3_AutoTrack/AutoTrack`

3.输入`python tracker.py`

4.将待识别的物体（人脸或猫）在车前移动，观察车的追踪行为

### 活动2：训练新的分类器

通过收集大量样本图片，可以训练自定义的分类器，可以识别任意的物体。

#### 1.环境准备

**在Windows桌面上执行：**

- 新建一个文件夹，重命名为待检测的物体名称（英文），比如检测移动电源，就命名为yidongdianyuan

- 进入文件夹，再新建两个文件夹，分别命名为`p`和`n`，p代表positive（正样本），n代表negative（负样本）

![微信截图_20191209141135](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209141135.png)

- 获取[分类器图形化训练软件](ftp://192.168.123.1/LEARN_AI/C4P3/CascadeTrainerGUI/)，下载安装。

- [获取图片批量处理软件](ftp://192.168.123.1/LEARN_AI/C4P3/图片批处理工具.zip),解压即可，主程序为`MtPcl.exe`

- 获取[示例数据集](ftp://192.168.123.1/LEARN_AI/C4P3/demodataset.zip)

#### 2.收集负样本

> 训练样本包括正样本和负样本。正样本，通俗点说，就是图片中只有你需要的目标。而负样本的图片只要其中不含有目标就可以了。但需要说明的是，负样本也并非随便选取的。
例如，需要检测的目标是汽车，那么正样本就应该是仅仅含有汽车的图片，而负样本显然不能是一些包含天空的，海洋的，风景的图片。因为最终训练分类器的目的是检测汽车，而汽车应该出现在马路上。也就是说，分类器最终检测的图片应该是那些包含马路，交通标志，建筑物，广告牌，汽车，摩托车，三轮车，行人，自行车等在内的图片。很明显，这里的负样本应该是包含摩托车、三轮车、自行车、行人、路面、灌木丛、花草、交通标志、广告牌等。
Adaboost方法是机器学习中的一个经典算法，而机器学习算法的前提条件是，测试样本和训练样本独立同分布。所谓的独立同分布，可以简单理解为：训练样本要和最终的应用场合非常接近或者一致。否则，基于机器学习的算法并不能保证算法的有效性。此外，足够的训练样本（至少得几千张正样本、几千张负样本）也是保证训练算法有效性的一个前提条件。

使用网络浏览器或各种方法，收集各种图片，但是不能包含待检测的物体（移动电源）。保存在`n`文件夹中。数量为数十个为宜。

![微信截图_20191209141601](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209141601.png)

#### 3.收集正样本

>正样本就是想要识别出来的物体。尽可能排除无关物体的干扰（图片中无其他物体）

使用手机，拍摄待识别的物体，并将其存储在`p`文件夹。数量在10个以上为宜。

![51ed384b11d617f32a9f22a93311168](https://md.hass.live/51ed384b11d617f32a9f22a93311168.jpg)

![微信截图_20191209140911](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209140911.png)

#### 4.图片预处理

这一步骤调整正负样本的图片分辨率。

- 打开`MtPcl.exe`，选择`添加文件夹`，选择`p`文件夹
![微信截图_20191209142158](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209142158.png)

- 选择右侧`修改尺寸`，高度设置为480，勾选`保持原图比例`。然后选择下面的`覆盖原图`。点击保存。
![微信截图_20191209142330](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209142330.png)

- 点击`清空`，并对`n`文件夹执行相同的操作
![微信截图_20191209142542](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209142542.png)

#### 5.训练分类器

- 打开`Cascade-Trainer-GUI`
![微信截图_20191209142731](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209142731.png)

- 点击`Browse`，选择包含`n`和`p`的文件夹
![微信截图_20191209143341](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209143341.png)

<center>路径中不能包含中文</center>
<p>

- 单击`Common`选项卡，调整第一项`Number of Stages`，选择10获得更快的训练速度，如果效果不明显可以逐渐增大，但是训练速度会显著增加。
![微信截图_20191209143627](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209143627.png)

- 修改宽度和高度为`20`，`30`。使宽高比和待处理的文件相同。
![微信截图_20191209144221](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209144221.png)

- 点击`Start`开始训练
![微信截图_20191209143833](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209143833.png)

- 训练成功后，在原文件夹中会增加一个`classifier`文件夹，里面的`cascade.xml`就是训练成功的级联分类器。
![微信截图_20191209144021](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209144021.png)

#### 6.测试

- 选择`Test`选项卡，点击右上角`Browse`，选择上一步的`cascade.xml`
- 输入设置，选择`Single Image`，测试图片可以是包含多个目标物体的图片或截图
- 选择输出方式为`Result Image in a Folder`，并指定路径
- 点击`Start`，最小检测阈值输入`10`，`10`；最大检测阈值输入`800`，`800`（可以不断调整以取得最好的效果）
![sdsadsds](https://md.hass.live/sdsadsds.png)

- 检测效果
![微信截图_20191209145205](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209145205.png)

### 活动3：应用新的分类器

将`cascade.xml`通过U盘拷贝到树莓派的路径下
![微信截图_20191209145535](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20191209145535.png)

**打开终端，执行：**

```bash
cd ~/Desktop/learn-ai/codes/chapter4/part3_AutoTrack/AutoTrack
python tracker_my_object.py
```

大白将会跟随训练的物体进行移动。
