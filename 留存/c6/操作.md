# 操作步骤

### 初始操作（已完成,无需操作或教师操作）

1.Win32DiskImager恢复镜像

2.在boot分区拷贝文件`wpa_supplicant.conf`

```bash
country=CN
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

network={
ssid="WiFi名字-不要删掉引号"
psk="WiFi密码-不要删掉引号"
key_mgmt=WPA-PSK
priority=1
}
```

### 环境安装（已完成，无需操作或教师操作）

1.树莓派通电，使用ssh连接。账号`pi`，密码`raspberry`

2.安装Docker
`curl -ssl https://get.docker.com | sh`

3.通过Docker安装HomeAssistant
`sudo docker run --init -d --name="home-assistant" -v /home/pi/homeassistant:/config -v /etc/localtime:/etc/localtime:ro --net=host homeassistant/raspberrypi3-homeassistant:0.82.0`

4.安装麦克风扩展板驱动
<https://github.com/waveshare/WM8960-Audio-HAT>

5.通过Docker安装Snowboy

```bash
//<https://github.com/Kitt-AI/snowboy>
sudo docker pull wupanhao/snowboy:1.0
//启动镜像
sudo docker run -idt --name="rapiro" --privileged -v /home/pi/rapiro:/rapiro wupanhao/snowboy:1.0 /bin/bash
//进入镜像
sudo docker exec -it rapiro env LANG=C.UTF-8 /bin/bash
```

### 参数配置

>参数配置时，都可以使用命令行文本编辑工具**nano**。用法是`nano 文件名`。退出时候按`Ctrl+W`，需要保存按`Y`,否则按`N`，然后按回车。

1.`~/rapiro/config.yaml`

```bash
# http://yuyin.baidu.com/
baidu_yuyin:
  api_key: 'qW5HLj4Ks6DfsCV2K9If5O80'
  secret_key: '37riCUCmGj1lfrhaGcyu11wWqCjvZbZR'
  app_id: '9217941'

homeassistant:
  url: 'http://localhost'
  port: '8123'
  password: 'welcome'

# http://www.turingapi.com/
tuling:
  key: 'be4efe7298b24d0d8c9b5542dd56671a'
```

2.`~/rapiro/opiro.py`

```python
#!coding:utf-8
import os
import time
import requests
class rapiro:
    def __init__(self,ip):
#把双引号里的地址替换为小绿的ip地址
        self.ip = "http://192.168.0.184"
        self.actions = {
            "停止":'/otto-home',
            "小绿前进":'/otto-walk',
            "小绿后退":'/otto-walk-back',
            "小绿挥手":'/wave-hands',
            "小绿左转":'/otto-turn',
            "小绿右转":'/otto-turn-right',
            """
            适用于小白的命令
            "小白前进":'/get?command=forward'
            "小白后退":'/get?command=backward'
            """
            }
    def get(self,url):
        r = requests.get(self.ip+url)
        print(r.text)
    def do(self,action):
        method = self.actions.get(action,None)
        if(method):
            self.get(method)
            print("rapiro " + action)
    def isValid(self,text):
        for key in self.actions.keys():
            if(key in text):
                return key
        return None

if __name__ == '__main__':
    #把双引号里的地址替换为小绿的ip地址
    rap = rapiro('http://192.168.0.184')
    action = rap.isValid('前进')
    print(action)
    if action:
        rap.do(action)
        #rap.do("前进")
    time.sleep(4)
    rap.do("挥手")
    time.sleep(4)
    rap.do("停止")
```

3.`~/rapiro/server.py`

```python
……
# 第84行 把引号里的地址替换为小绿的ip地址
rap = rapiro('http://192.168.0.184')
……
```

4.`~/rapiro/handle.py`

```python
#!coding:utf-8
from rapiro import *
rap = rapiro()
def handle(str):
# 仿照下一行的格式，补充更多的关键词，优化小绿的智力
# 如果语句命令中包含关键词，则将会识别为对应的机器人指令
    cmds = ["前进","后退","左转","右转","停止"]
    for cmd in cmds:
        if(cmd in str):
            rap.do(cmd)
            break
```

5.`~/.asoundrc`声音设备配置

```bash
//使用`aplay -l`和`arecord -l`查看wm8960soundcard对应的card和device号码。
//例如，如果aplay对应的card和device分别是1和0，
//则在playback.pcm处的双引号内填入`hw:1,0`，
//arecord则在capture.pcm处填写。

pcm.!default {
    type asym
    playback.pcm {
        type plug
        slave.pcm "hw:1,0"
    }

capture.pcm {
    type plug
    slave.pcm "hw:1,0"
    }
}
```

### 训练自己的语音触发

>语音唤醒模型的训练是基于深度神经网络的训练。采用神经网络作为特征提取器，把声波信息转化为多维特征向量输入到深度神经网络（DNN）中，进行训练，得到模型。

![微信截图_20190827155220](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190827155220.png)

**嘿，Siri！**
**OK，Google！**
**小爱同学！**
**小度小度！**

这些是主流的语音助手的唤醒词。小绿也有自己的唤醒词。
当我们呼唤他**小绿**的时候，他就会回应。这是因为已经提前训练好的识别文件`green.pmbl`

当然，我们可以训练自己独特的唤醒词。你想要叫他什么？叫什么都可以~只需要稍微的训练一下，得到一个识别文件就可以了。

1.登陆网址[叫我的机器人什么好呢](https://snowboy.kitt.ai/)
你需要有一个GitHub账号，然后在右上角选择`Login with GitHub`

- 登陆后的界面：
![微信截图_20190827153711](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190827153711.png)

2.选择Create Hotword

![微信截图_20190827153845](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190827153845.png)

3.选择右下角的Record my voice

![微信截图_20190827154111](https://md.hass.live/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20190827154111.png)

4.录制3个样本后，点击右下角的按钮进行模型训练

![sssss](https://md.hass.live/sssss.png)

在左侧选择你的性别和年龄段，这是为了更加准确的调整模型。
然后在右侧说出唤醒词，通过调整灵敏度，逐渐调节到最优状态。然后点击`Save and download`

5.将下载好的模型文件放在项目文件夹里，可以命名为myrobot.pmbl

### 启动小绿的语音系统

```bash
cd ~/rapiro
python server.py green.pmdl
//或者使用自己训练的myrobot.pmbl
//python server.py myrobot.pmbl
```

对着麦克风说`小绿`，听到提示音后，说出你的问题。你可以说`今天的天气怎么样？`、`讲个笑话`、`小绿前进/后退/跳舞`、`小白前进/左转/停车`等。
试着用你的唤醒词来叫醒机器人吧

---

### HomeAssistant的参与

#### 启动HomeAssistant

`sudo docker start home-assistant`
启动大概需要1分钟

#### 配置HomeAssistant

`sudo docker exec -it home-assistant env LANG=C.UTF-8 /bin/bash`
退出输入`exit`

#### 访问HomeAssistant

`树莓派ip:8123`，选择API密码登陆，密码`welcome`
